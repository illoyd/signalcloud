-# UI variables
- ticket_path = new_appliance_ticket_path( @appliance.nil? ? @account.default_appliance : @appliance )

/ Page header
.row
  .span12
    .page-header
      %h1
        = icon( :tickets )
        Tickets
        %small
          all tickets
          - unless @appliance.nil?
            = "for #{@appliance.label}"

/ Page controls
.row
  .span12.table-tools
    = appliance_dropdown_list( @account, @appliance )
    = status_dropdown_list( @account, @appliance, params[:status] )
    - if can? :new, Ticket
      .pull-right= link_to 'Start a new ticket', ticket_path, :class=>'btn btn-success btn-small'

/ Page body
.row
  .span12
    %table.table.table-condensed
      %thead
        %tr
          %th
          - if @multiappliance
            %th Appliance
          %th Status
          %th From number
          %th To number
          %th Expires On
          %th
            %span{ rel: 'tooltip', title: 'Message sent to person' }
              = icon( :rss )
              = icon( 'arrow-right' )
              = icon( :user )
          %th
            %span{ rel: 'tooltip', title: 'Message received from person' }
              = icon( :rss )
              = icon( 'arrow-left' )
              = icon( :user )
          %th
            %span{ rel: 'tooltip', title: 'Reply sent to person' }
              = icon( :rss )
              = icon( 'arrow-right' )
              = icon( :user )
            / Manage toolbox
      %tbody
        - if @tickets.empty?
          %tr
            %td{ colspan: 8 + (@multiappliance ? 1 : 0) }
              %em No tickets match your selected filters. Please remove your filters to see more tickets.
        
        - @tickets.each do |ticket|
          %tr{ :class=>ticket_class(ticket.status) }
            %td= split_dropdown_list([ |
                { label: 'Details', icon: :show, link: ticket, if: can?(:show, ticket) }, |
                { label: 'Force status to Confirmed', icon: 'ok-sign', link: ticket, if: can?(:force, ticket) }, |
                { label: 'Force status to Denied', icon: 'minus-sign', link: ticket, if: can?(:force, ticket) }, |
                { label: 'Force status to Failed', icon: 'remove-sign', link: ticket, if: can?(:force, ticket) }, |
                { label: 'Force status to Expired', icon: :time, link: ticket, if: can?(:force, ticket) } |
              ], {class: 'btn-mini'} ) |
            - if @multiappliance
              %td= link_to ticket.appliance.label, ticket.appliance
            %td
              = link_to ticket do
                = ticket_status_icon(ticket.status)
                = human_ticket_status(ticket.status)
            %td= humanize_phone_number Phony.normalize ticket.from_number
            %td= humanize_phone_number Phony.normalize ticket.to_number
            %td= ticket.expiry
            %td{style:'text-align:center'}= ticket.challenge_sent ? icon(:ok) : ''
            %td{style:'text-align:center'}= ticket.response_received ? icon(:ok) : ''
            %td{style:'text-align:center'}= ticket.reply_sent ? icon(:ok) : ''

  = paginate @tickets